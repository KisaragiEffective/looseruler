# LooseRuler
LooseRuler は Git のブランチ間マージにおいて自分が望む差分のみを構造的に選択しながら素早くマージするためのツールです。

## 動機
私は[Misskey](https://github.com/misskey-dev/misskey)という国産SNSのフォークレポジトリを運用している時に、度々Misskeyプロジェクトの変更とかち合うような変更を入れてきました。
かち合うということは、Gitがマージする時にコンフリクトするため、hunkを操って解決しなければなりません。
しかし、私は時間がないため、そのような非本質的な解決を手動でやりたくはありません。
そこで、このツールの出番です。
このツールはneglidiaを始めとする外部ツールを自動的に呼び出して、手動での決定が介在しない素早いマージを可能とします。

## 要求プログラム
* [neglidia](https://github.com/KisaragiEffective/neglidia)
* pnpm
* bash

## 使い方
1. neglidia 及び pnpm をインストールします。
2. 次のコマンドで LooseRuler 本体を起動します。 `YOURS`はマージする先のブランチ名に、`THEIRS`はLooseRulerで内容を読み取ってマージするブランチ名に置き換えてください。
    ```shell
    GIT_DIRECTORY="/path/to/git/directory/root" \
    YOURS="your-branch-name-here" \
    THEIRS="upstream-branch-name-here" \
    NEGLIDIA_SRC_DIR="/path/to/neglidia/source" \
    main.sh
    ```

## 動作原理
1. ブランチ `YOURS` 及び ブランチ `THEIRS` に共通するコミットをとってきます。このコミットを `c` とします。
2. `c` の次コミットから `THEIRS` の最終コミットまでの各コミットについて、
    1. 前のコミットとの差分を見ながらルールベースで各ファイルについての変更を受け入れるかリバートするか決定します。
    2. マージ用の一時ブランチに変更が蓄積されます。
3. `YOURS` にマージ用の一時ブランチがマージされます。

ただし、各段階においてコンフリクトしない場合はその変更を受け入れることを暗黙のうちに仮定し、コンフリクトするまでマージを延期する場合があります。
そのような場合で、警告が表示された場合はマージコミットの中身を確かめてください。

なお、与えられたGitレポジトリの設定のいかんに関わらず、このツールは履歴の錯誤を起きにくくするためマージコミットを生成します。
もしマージコミットを望まない場合はマージ用の一時ブランチがマージされる前のコミットまでの変更をsquashする必要があります。
